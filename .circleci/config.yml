version: 2

aliases:
  - &install_common |
      apt-get update -qq
      apt-get --no-install-recommends install asciidoc xmlto libkmod-dev libudev-dev uuid-dev libjson-c-dev
      apt-get install -qq autoconf automake cmake doxygen gcc g++ libtool libnuma-dev rapidjson-dev libtbb-dev

jobs:
  build:
    docker:
      - image: ubuntu:bionic
    steps:
      - run: *install_common
      - run: |
          git clone https://github.com/pmem/ndctl.git
          cd ndctl
          git checkout tags/v60.1
          ./autogen.sh
          ./configure
          make
          make install
          cp ndctl/ndctl.h /usr/include/linux
          cp config.h /usr/include
          cp -r ccan /usr/include
          cd ..
      - run: |
          git clone https://github.com/pmem/pmdk
          cd pmdk
          git checkout 695e6eba28c53a69a0ef7bad3cc0f45c21ef3e00
          make
          make install
          cd ..
      - run: |
          git clone https://github.com/pmem/libpmemobj-cpp
          cd libpmemobj-cpp
          git checkout 8d86c76c81167d9e352158ad87f169f554e5d794
          mkdir build
          cd build
          cmake ..
          make
          make install
          cd ../..
      - run: |
          git clone https://github.com/memkind/memkind
          cd memkind
          git checkout v1.9.0
          ./build.sh
          make install
          cd ..
      - run: |
          git clone https://github.com/pmem/pmemkv
          cd pmemkv
          make
          make install
          cd ..
      - run: |
          wget https://raw.githubusercontent.com/rust-lang/rustup.rs/master/rustup-init.sh
          chmod u+x rustup-init.sh
          ./rustup-init.sh -y
          export PATH=$HOME/.cargo/bin:$PATH
      - checkout
      - run: |
          cargo build --verbose --all
          cargo test --verbose --all
